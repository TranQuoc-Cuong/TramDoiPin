<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hướng Dẫn Đổi Pin - Trạm Pin ESP32</title>
    <style>
        body {
            background-color: #f4f4f4;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding-bottom: 40px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 5%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.5em; color: #333; margin: 0; }
        .back-btn {
            background-color: #6c757d; color: white; padding: 10px 20px;
            border: none; border-radius: 5px; cursor: pointer;
            font-weight: bold; text-decoration: none;
            transition: background-color 0.2s;
        }
        .back-btn:hover { background-color: #5a6268; }
        .instructions-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 40px 20px;
        }
        .instruction-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 30px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }
        .instruction-text h2 {
            margin-top: 0; font-size: 1.5em; color: #333;
        }
        .instruction-text p {
            font-size: 1.1em; color: #555;
            line-height: 1.6; margin-bottom: 0;
        }
        .slot-number {
            font-size: 4em; font-weight: bold; padding-left: 20px;
        }
        .take-out { border-top: 6px solid #4CAF50; }
        .take-out .slot-number { color: #4CAF50; }
        .put-in { border-top: 6px solid #ff9800; }
        .put-in .slot-number { color: #ff9800; }

        /* CSS cho phần chi tiết pin được thêm vào */
        .inserted-pin-details {
            display: none; /* Ẩn ban đầu */
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 15px; font-size: 0.95em; text-align: left;
        }
        .info-item { background-color: #f8f9fa; padding: 10px 15px; border-radius: 8px; }
        .info-item .label { color: #6c757d; font-size: 0.85em; display: block; }
        .info-item .value { font-weight: 600; font-size: 1.15em; }
        .value.status-error-text { color: #dc3545; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Thực Hiện Đổi Pin</h1>
        <a href="dashboard.html" class="back-btn">Quay Lại</a>
    </div>

    <div class="instructions-container">
        <div class="instruction-card put-in">
            <div class="card-header">
                <div class="instruction-text" id="put-in-text">
                    <h2>Bước 1: Đặt Pin Cần Sạc Vào</h2> 
                    <p>Vui lòng đặt pin của bạn vào khay trống dưới đây:</p> 
                </div>
                <div class="slot-number" id="empty-pin-slot">...</div>
            </div>
            <div class="inserted-pin-details" id="inserted-pin-details">
                 <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Dung lượng</span>
                        <span class="value percent">--%</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Trạng thái</span>
                        <span class="value status">--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Điện áp</span>
                        <span class="value voltage">-- V</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Nhiệt độ</span>
                        <span class="value temperature">-- °C</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="instruction-card take-out">
            <div class="card-header">
                <div class="instruction-text">
                    <h2>Bước 2: Lấy Pin Đã Sạc Đầy</h2>
                    <p>Vui lòng lấy pin đã được sạc đầy ra khỏi khay số:</p>
                </div>
                <div class="slot-number" id="full-pin-slot">...</div>
            </div>
        </div>
    </div>

    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;
        let emptySlotToMonitor = null; // Biến để lưu ID của khe cần theo dõi

        window.addEventListener('load', initWebSocket);

        function initWebSocket() {
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onmessage = onMessage;
            websocket.onclose = () => setTimeout(initWebSocket, 2000);
        }

        function onOpen(event) {
            websocket.send('getSwapSlots');
        }

        function onMessage(event) {
            let data;
            try { data = JSON.parse(event.data); } catch(e) { return; }

            // Xử lý tin nhắn ban đầu để lấy số khe
            if (data.type === 'swapSlots' || data.type === 'swapSlotsUpdate') {
                document.getElementById('full-pin-slot').innerText = data.full;
                document.getElementById('empty-pin-slot').innerText = data.empty;
                // Lưu lại số khe trống để theo dõi
                if (data.empty !== 'đợi') {
                    emptySlotToMonitor = parseInt(data.empty, 10);
                }
            }

            // Xử lý tin nhắn dữ liệu pin thời gian thực
            if (data.type === 'pinData' && data.id === emptySlotToMonitor && data.status !== 'Trống') {
                const detailsContainer = document.getElementById('inserted-pin-details');
                // Hiển thị khung chi tiết và cập nhật dữ liệu
                if (detailsContainer.style.display !== 'block') {
                    detailsContainer.style.display = 'block';
                    const instructionText = document.getElementById('put-in-text').querySelector('p');
                    instructionText.textContent = 'Đã phát hiện pin, đang kiểm tra trạng thái...';
                }
                
                detailsContainer.querySelector('.percent').innerText = `${data.percent}%`;
                detailsContainer.querySelector('.voltage').innerText = `${data.voltage.toFixed(2)} V`;
                detailsContainer.querySelector('.temperature').innerText = `${data.temperature.toFixed(1)} °C`;

                const statusElement = detailsContainer.querySelector('.status');
                statusElement.innerText = data.status;

                // Thêm màu cho chữ nếu có lỗi
                statusElement.classList.remove('status-error-text');
                if (data.status === 'Lỗi' || data.status === 'Nhiệt Độ Cao') {
                    statusElement.classList.add('status-error-text');
                }
            }
        }
    </script>
</body>
</html>